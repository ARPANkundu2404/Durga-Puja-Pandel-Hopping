package com.arpan.durga_puja_hopping.service.impl;

import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import com.arpan.durga_puja_hopping.dto.LoginRequest;
import com.arpan.durga_puja_hopping.dto.UserAddRequest;
import com.arpan.durga_puja_hopping.dto.UserRequest;
import com.arpan.durga_puja_hopping.entity.UserDtls;
import com.arpan.durga_puja_hopping.repository.UserDtlsRepository;
import com.arpan.durga_puja_hopping.service.JwtService;
import com.arpan.durga_puja_hopping.service.UserService;

import jakarta.transaction.Transactional;

@Service
public class UserServiceImpl implements UserService {
	
	@Value("${APP_ADMIN_SECRET}")
    private String adminSecret;

	@Autowired
	private AuthenticationManager authenticationManager;

	@Autowired
	private JwtService jwtService;

	@Autowired
	private UserDtlsRepository userDtlsRepository;
	
	@Autowired
	private BCryptPasswordEncoder passwordEncoder;

	@Autowired
	private OtpServiceImpl otpServiceImpl;
	

	@Override
	public String login(LoginRequest loginRequest) {
		Authentication authentication = authenticationManager.authenticate(
				new UsernamePasswordAuthenticationToken(loginRequest.getEmail(), loginRequest.getPassword()));
		if (authentication.isAuthenticated()) {
						UserDetails userDetails = (UserDetails) authentication.getPrincipal();
						String role = userDetails.getAuthorities().iterator().next().getAuthority();
						UserDtls userDtls = userDtlsRepository.findByEmail(loginRequest.getEmail())
                                .orElseThrow(() -> new RuntimeException("Authenticated user not found in database"));

						String name = userDtls.getName();
						String rawRole = userDtls.getRole();
						
						return jwtService.generateToken(loginRequest.getEmail(), role, name);
		}
		return null;
	}

	@Override
	public UserDtls registerUser(UserAddRequest request) {

	    if (userDtlsRepository.existsByEmailIgnoreCase(request.getEmail())) {
	        throw new RuntimeException("Email already registered");
	    }

	    UserDtls user = new UserDtls();
	    user.setName(request.getName());
	    user.setEmail(request.getEmail());
	    user.setMobileno(request.getMobileno());
	    user.setPassword(passwordEncoder.encode(request.getPassword()));

	    String role = request.getRole();

        // ‚úÖ Default role
        if (role == null || role.isBlank()) {
            user.setRole("USER");
        }
        // üîê ADMIN with secret validation
        else if ("ADMIN".equalsIgnoreCase(role)) {

            if (request.getSecretCode() == null ||
                !request.getSecretCode().equals(adminSecret)) {
                throw new RuntimeException("Invalid admin secret code");
            }

            user.setRole("ADMIN");
        }
        // AUTHORITY
        else if ("AUTHORITY".equalsIgnoreCase(role)) {
            user.setRole("AUTHORITY");
        }
        else {
            throw new RuntimeException("Invalid role requested");
        }

	    return userDtlsRepository.save(user);
	}


	@Override
	@Transactional
	public String updatePassword(UserRequest request) {
		// validate OTP first
		boolean isValid = otpServiceImpl.validateOtp(request.getEmail(), request.getOtp());
		if (!isValid) {
			return "Invalid or expired OTP";
		}

		// update password if OTP valid
		Optional<UserDtls> optionalUser = userDtlsRepository.findByEmail(request.getEmail());

		if (optionalUser.isEmpty()) {
			return "User not found";
		}

		UserDtls user = optionalUser.get();
		user.setPassword(passwordEncoder.encode(request.getPassword())); // Getting the new password
		userDtlsRepository.save(user);

		return "Password updated successfully";
	}
	
	@Override
	public UserDtls getUserByEmail(String email) {
	    return userDtlsRepository.findByEmail(email)
	            .orElseThrow(() -> new RuntimeException("User not found with email: " + email));
	}


}
